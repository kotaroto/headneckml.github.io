<!DOCTYPE html>
<html lang="en">

<head>
  <title>TympClass Classifier</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link href="https://fonts.googleapis.com/css?family=Work+Sans:100,200,300,400,700,800" rel="stylesheet">

  <link rel="stylesheet" href="css/open-iconic-bootstrap.min.css">
  <link rel="stylesheet" href="css/animate.css">

  <link rel="stylesheet" href="css/owl.carousel.min.css">
  <link rel="stylesheet" href="css/owl.theme.default.min.css">
  <link rel="stylesheet" href="css/magnific-popup.css">

  <link rel="stylesheet" href="css/aos.css">

  <link rel="stylesheet" href="css/ionicons.min.css">

  <link rel="stylesheet" href="css/bootstrap-datepicker.css">
  <link rel="stylesheet" href="css/jquery.timepicker.css">


  <link rel="stylesheet" href="css/flaticon.css">
  <link rel="stylesheet" href="css/icomoon.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/basic.min.css">
  <link rel="stylesheet" href="css/dropzone.min.css">


</head>
<style>
  /* DIV table style */

  .div-table {
    display: table;
    width: 100%;
    background-color: #fff;
  }

  .div-tr {
    display: table-row;
  }

  .div-th,
  .div-td {
    display: table-cell;
    padding: 2px 5px;
    border-bottom: 1px solid #eaeff0;
    vertical-align: middle;
  }

  .div-thead {
    display: table-header-group;
    font-weight: bold;
  }

  .div-tfoot {
    display: table-footer-group;
    font-weight: bold;
    background-color: #fff;
  }

  .div-tbody {
    display: table-row-group;
  }
</style>


<body>

  <nav class="navbar navbar-expand-lg navbar-dark ftco_navbar bg-dark ftco-navbar-light" id="ftco-navbar">
    <div class="container">
      <a class="navbar-brand" href="/">HeadNeckML.</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#ftco-nav"
        aria-controls="ftco-nav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="oi oi-menu"></span> Menu
      </button>

      <div class="collapse navbar-collapse" id="ftco-nav">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item active"><a href="/" class="nav-link">Home</a></li>
          <li class="nav-item"><a href="/" class="nav-link">About</a></li>
          <li class="nav-item"><a href="/" class="nav-link">Services</a></li>

          <li class="nav-item"><a href="/" class="nav-link">Case Studies</a></li>
          <li class="nav-item cta"><a href="/" class="nav-link"><span>Try it out!</span></a></li>
        </ul>
      </div>
    </div>
  </nav>
  <!-- END nav -->

  <!-- <div class="js-fullheight"> -->
  <div class="hero-wrap js-fullheight">
    <div class="overlay" style="position: fixed;"></div>
    <div id="particles-js" style="position: fixed;"></div>
    <br>
    <div class="container">
      <div class="row no-gutters slider-text align-items-start justify-content-center" data-scrollax-parent="true"
        style="top: 150px;">
        <div class="col-lg-5 col-md-12">
          <section class="ftco-section ftco-degree-bg" style="background-color: #eaeff0; padding: 2em;">
            <div class="container">
              <div class="row">
                <div class="col-md-12 col-sm-10 ftco-animate">
                  <p>
                    <img src="images/model_explainer_cerumen.png" alt="" class="img-fluid">
                  </p>
                  <h2 class="mb-3">Tympanic Membrane Abnormality Classifier</h2>
                  <p>We have created an original tympanic membrane (TM) image classifier based on a deep learning algorithm. 
                    The model has been trained on an original database consisting of a total of 400 images developed by
                    utilizing publicly available online databases and images and has achieved high performance metrics (AUROC > 0.9, 
                    accuracy > 0.7). The TM classifer platform is capable of categorizing input images in a binary fashion 
                    (normal vs. abnormal) or in a multiclass fashion (normal, acute otitis media, otitis externa, chronic 
                    suppurative otitis media, and cerumen).
                 </p>

                  <h2 class="mb-3">#2. Try some of the images below. Download the images and test our classifier.</h2>
                  <p>
                    <a download="test-image.jpg" href="images/100_0095.png">
                      <img src="images/100_0095.png" alt="" class="img-fluid" style="max-width: 224px; max-height: 224px;">
                    </a>
                    
                  </p>
                </div> <!-- .col-md-8 -->

              </div>
            </div>
          </section> <!-- .section -->
        </div>
        <div class="col-lg-7 col-md-10 col-sm-10 ftco-section ftco-animate text-center" style="padding-left: 2em;padding-right: 2em;">
          <h1 class="mb-4">Use the
            <strong>dropzone</strong> to try our model</h1>


          <form action="/upload/" class="dropzone" id="uploadzone" style="color:#8b8b92">
            <DIV class="dz-message needsclick">
              Drop images here or click to upload.<BR>
              <SPAN class="note needsclick">(The results for each uploaded image will be shown in the table
                <strong>below</strong>)</SPAN>
            </DIV>
          </form>
          <br />
          <div class="row">
            <div class="col-md-10"></div>
            <div class="col-md-2">
              <button class="button btn btn-primary clear-all">Clear All</button>
            </div>
          </div>

          <div id="preview-template" class="table-responsive-sm" style="display: none;">
            <div class="div-tr">
              <div class="div-td">
                <div class="dz-filename"><span data-dz-name></span></div>
                <div class="dz-size" data-dz-size></div>


              </div>
              <div class="div-td">
                <div class="dz-preview dz-file-preview">
                  <img data-dz-thumbnail />

                  <div class="dz-progress"><span class="dz-upload" data-dz-uploadprogress></span></div>
                  <div class="dz-success-mark"><span>✔</span></div>
                  <div class="dz-error-mark"><span>✘</span></div>
                  <div class="dz-error-message"><span data-dz-errormessage></span></div>
                </div>
              </div>
              <div class="div-td"><span class="pred-label" data-dz-label></span> </div>
              <div class="div-td"><span class="pred-prob" data-dz-prob></span></div>

              <div class="div-td"><span class="pred-multi-label" data-dz-label></span> </div>
              <div class="div-td" style="text-align: left; "><span class="pred-multi-prob " data-dz-prob></span></div>
              <div class="div-td">
                <span data-dz-remove><a href="#"><i class="icon-times" alt="Click me to remove the file."></i> Remove
                    Image</a></span>
              </div>
            </div>

          </div>

          <br>

          <div id="dropzone-preview" class="dropzone-previews dropzone div-table" style="color:#222225">
            <div class="div-tr">
              <div class="div-th">Image Info</div>
              <div class="div-th">Image Preview</div>
              <div class="div-th">Classification Label</div>
              <div class="div-th">Class probabilities <br> (Normal, Abnormal)</div>
              <div class="div-th">Multi Classification Label</div>
              <div class="div-th">Multi Class probabilities <br> (Normal, AOM, CSOM, Cerumen, OE)</div>
              <div class="div-th">-</div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>



  <!-- loader -->
  <div id="ftco-loader" class="show fullscreen"><svg class="circular" width="48px" height="48px">
      <circle class="path-bg" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke="#eeeeee" />
      <circle class="path" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke-miterlimit="10"
        stroke="#F96D00" /></svg></div>



  <script src="js/jquery.min.js"></script>
  <script src="js/jquery-migrate-3.0.1.min.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/jquery.easing.1.3.js"></script>
  <script src="js/jquery.waypoints.min.js"></script>
  <script src="js/jquery.stellar.min.js"></script>
  <script src="js/owl.carousel.min.js"></script>
  <script src="js/jquery.magnific-popup.min.js"></script>
  <script src="js/aos.js"></script>
  <script src="js/jquery.animateNumber.min.js"></script>
  <script src="js/bootstrap-datepicker.js"></script>
  <script src="js/jquery.timepicker.min.js"></script>
  <script src="js/particles.min.js"></script>
  <script src="js/particle.js"></script>
  <script src="js/scrollax.min.js"></script>
  <script src="js/main.js"></script>


  <script src="js/dropzone.min.js"></script>


  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"> </script>

  <script>
    (async () => {
      model_binary = await tf.loadLayersModel("tensorflowjs/binary/model.json", strict = false);
      model_multi = await tf.loadLayersModel("tensorflowjs/multi/model.json");

    })();

  </script>

  <script defer>
    Dropzone.autoDiscover = false;
    var LABELS = ["Normal", "AOM", "CSOM", "Cerumen", "OE"];
    var LABELS_BIN = ["Normal", "Abnormal"];
    $(document).ready(() => {

      $('.clear-all').on("click", () => {
        Dropzone.forElement('#uploadzone').removeAllFiles(true);
      });

      function preprocess(img) {
        //convert the image data to a tensor 
        let tensor = tf.browser.fromPixels(img)
        //resize to 50 X 50
        const resized = tf.image.resizeBilinear(tensor, [224, 224]).toFloat()
        // Normalize the image 
        const offset = tf.scalar(255.0);
        const normalized = tf.scalar(1.0).sub(resized.div(offset));
        //We add a dimension to get a batch shape 
        const batched = normalized.expandDims(0)
        return batched
      }

      $('#uploadzone').dropzone({
        previewsContainer: "#dropzone-preview",
        previewTemplate: document.getElementById('preview-template').innerHTML,
        acceptedFiles: 'image/*',
        maxFilesize: 20,
        autoProcessQueue: false,
        init: function () {
          this.on("addedfile", function (file) {
            console.log(file);
            var reader = new FileReader();
            reader.onload = function (event) {

              var img = new Image();
              img.src = event.target.result;
              img.onload = () => {

                let procImg = preprocess(img);

                const axis = 1;



                const probs_multi = model_multi.predict(procImg);
                const pred_mutli = Array.from(probs_multi.argMax(axis).dataSync());
                let prob_multi = Array.from(probs_multi.dataSync());

                const probs_binary = model_binary.predict(procImg);
                const pred_binary = Array.from(probs_binary.argMax(axis).dataSync());
                let prob_binary = Array.from(probs_binary.dataSync());
                console.log(prob_binary);
                //binary 
                $(file.previewTemplate).find('.pred-label').append(document.createTextNode(LABELS_BIN[pred_binary]));

                prob_binary = prob_binary.map(function (prob) {
                  return prob.toFixed(1);
                });
                $(file.previewTemplate).find('.pred-prob').append(document.createTextNode(prob_binary));


                //multi
                $(file.previewTemplate).find('.pred-multi-label').append(document.createTextNode(LABELS[pred_mutli]));

                prob_multi.forEach(function (prob, i) {
                  var LABELS = ["Normal", "AOM", "CSOM", "Cerumen", "OE"];
                  $(file.previewTemplate).find('.pred-multi-prob').append(document.createTextNode(LABELS[i] + ":" + prob.toFixed(1)));
                  $(file.previewTemplate).find('.pred-multi-prob').append(document.createElement("br"));
                });

                $(file.previewTemplate).find('.dz-progress').fadeOut();
              };

            };
            reader.readAsDataURL(file);

          });


        },
        url: '/'
      });
    });
  </script>


</body>

</html>
